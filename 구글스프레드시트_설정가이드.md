# 📊 구글 스프레드시트 연동 설정 가이드

이 가이드는 상담 스케줄 관리 시스템을 **구글 스프레드시트**와 연동하는 방법을 안내합니다.

---

## 📋 목차

1. [구글 스프레드시트 생성](#1-구글-스프레드시트-생성)
2. [Apps Script 설정](#2-apps-script-설정)
3. [웹 앱 배포](#3-웹-앱-배포)
4. [로컬 서버 설정](#4-로컬-서버-설정)
5. [테스트](#5-테스트)
6. [문제 해결](#6-문제-해결)

---

## 1. 구글 스프레드시트 생성

### 1-1. 새 스프레드시트 만들기

1. [Google Sheets](https://sheets.google.com) 접속
2. **빈 스프레드시트** 만들기 클릭
3. 스프레드시트 이름을 `상담 스케줄 관리` 로 변경

### 1-2. 헤더 설정

첫 번째 행(A1~G1)에 다음 헤더를 입력하세요:

| A | B | C | D | E | F | G |
|---|---|---|---|---|---|---|
| id | counselor | date | startTime | endTime | clientName | sessionNumber |

**중요**: 
- 헤더 이름은 **정확히** 위와 같이 입력해야 합니다 (대소문자 구분)
- 철자가 틀리면 데이터가 제대로 저장되지 않습니다

### 1-3. 시트 이름 확인

- 스프레드시트 하단의 시트 탭 이름이 `Sheet1` 인지 확인
- 다른 이름이면 `Sheet1`로 변경하거나, `Code.gs` 파일의 `SHEET_NAME` 변수를 수정

---

## 2. Apps Script 설정

### 2-1. Apps Script 편집기 열기

1. 스프레드시트 상단 메뉴에서 **확장 프로그램** 클릭
2. **Apps Script** 선택
3. 새 탭에서 Apps Script 편집기가 열립니다

### 2-2. 코드 복사

1. 편집기의 기본 코드(`function myFunction() {}`)를 **모두 삭제**
2. 프로젝트 폴더의 `Code.gs` 파일 내용을 **전체 복사**
3. Apps Script 편집기에 **붙여넣기**

### 2-3. 코드 내용 확인

붙여넣은 코드에서 다음 부분을 확인하세요:

```javascript
const SHEET_NAME = "Sheet1"; // 스프레드시트 시트 이름과 일치해야 함
```

### 2-4. 저장

1. 상단의 **디스크 아이콘** 클릭 또는 `Ctrl+S` (Mac: `Cmd+S`)
2. 프로젝트 이름을 `상담스케줄API` 로 설정

---

## 3. 웹 앱 배포

### 3-1. 배포 시작

1. Apps Script 편집기 상단 오른쪽의 **배포** 버튼 클릭
2. **새 배포** 선택

### 3-2. 배포 설정

**배포 유형 선택:**
- 톱니바퀴 아이콘 클릭
- **웹 앱** 선택

**설정 입력:**

| 항목 | 설정 값 |
|------|---------|
| **설명** | `초기 배포` (원하는 설명 입력) |
| **다음 사용자로 실행** | **나** 선택 |
| **액세스 권한** | **전체 사용자** 선택 |

**중요**: 
- "다음 사용자로 실행"은 반드시 **나**로 설정
- "액세스 권한"은 **전체 사용자**로 설정 (팀원들이 접근 가능)

### 3-3. 권한 승인

1. **배포** 버튼 클릭
2. **액세스 승인** 팝업이 나타나면 **액세스 승인** 클릭
3. Google 계정 선택
4. **고급** 클릭 (보안 경고가 나타날 수 있음)
5. **[프로젝트명](으)로 이동** 클릭
6. **허용** 클릭

### 3-4. 웹 앱 URL 복사

1. 배포가 완료되면 **웹 앱 URL**이 표시됩니다
2. URL 형식: `https://script.google.com/macros/s/XXXXX.../exec`
3. **복사** 버튼을 클릭하여 URL을 복사하세요
4. 이 URL을 안전한 곳에 보관하세요 (다음 단계에서 사용)

---

## 4. 로컬 서버 설정

### 4-1. dotenv 패키지 설치

터미널에서 다음 명령어를 실행하세요:

```bash
cd /Users/joseph/Downloads/celender-main
npm install
```

### 4-2. .env 파일 설정

1. 프로젝트 폴더에서 `.env` 파일을 엽니다
2. 다음과 같이 수정하세요:

```env
# 구글 Apps Script 웹 앱 URL
GOOGLE_SCRIPT_URL=여기에_복사한_URL_붙여넣기
```

**예시:**
```env
GOOGLE_SCRIPT_URL=https://script.google.com/macros/s/AKfycbxXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX/exec
```

**주의사항:**
- `=` 앞뒤에 공백이 없어야 합니다
- URL 전체를 따옴표 없이 붙여넣으세요
- URL 끝의 `/exec`까지 포함해야 합니다

### 4-3. 서버 시작

```bash
npm start
```

서버가 정상적으로 시작되면 다음과 같은 메시지가 표시됩니다:

```
🚀 ========================================
🎯 상담 스케줄 관리 시스템 서버 시작!
🌐 서버 주소: http://localhost:3000
📊 데이터 저장: 구글 스프레드시트
🚀 ========================================
```

---

## 5. 테스트

### 5-1. 브라우저 접속

1. 웹 브라우저를 열고
2. `http://localhost:3000` 접속

### 5-2. 스케줄 추가 테스트

1. **[스케줄 추가]** 버튼 클릭
2. 테스트 데이터 입력:
   - 상담사: 테스트상담사
   - 날짜: 오늘 날짜
   - 시작 시간: 09:00
   - 종료 시간: 10:00
   - 내담자명: 테스트내담자
   - 회기: 1
3. **[저장]** 클릭

### 5-3. 구글 스프레드시트 확인

1. 구글 스프레드시트로 돌아가기
2. 2번째 행에 방금 입력한 데이터가 추가되었는지 확인
3. 데이터가 보이면 **연동 성공!** ✅

### 5-4. 실시간 동기화 테스트

**방법 1: 웹에서 추가 → 스프레드시트 확인**
- 웹에서 스케줄 추가
- 스프레드시트에 자동 추가됨

**방법 2: 스프레드시트에서 직접 수정 → 웹에서 확인**
- 스프레드시트에서 데이터 직접 입력/수정
- 웹에서 새로고침 버튼 클릭
- 변경사항이 반영됨

---

## 6. 문제 해결

### ❌ "GOOGLE_SCRIPT_URL 환경 변수가 설정되지 않았습니다"

**원인**: `.env` 파일이 없거나 URL이 설정되지 않음

**해결 방법:**
1. `.env` 파일이 프로젝트 폴더에 있는지 확인
2. 파일 내용에 `GOOGLE_SCRIPT_URL=` 뒤에 URL이 있는지 확인
3. 서버를 재시작 (`Ctrl+C` 후 `npm start`)

---

### ❌ "Google Apps Script 응답 오류: 403"

**원인**: Apps Script 배포 시 권한 설정 오류

**해결 방법:**
1. Apps Script 편집기로 돌아가기
2. **배포 관리** 클릭
3. 현재 배포의 연필 아이콘(편집) 클릭
4. **액세스 권한**을 **전체 사용자**로 변경
5. **버전 배포** 클릭
6. 새 URL 복사하여 `.env` 파일 업데이트

---

### ❌ 데이터가 스프레드시트에 저장되지 않음

**원인 1: 헤더 이름 불일치**
- 스프레드시트의 헤더가 정확한지 확인
- 대소문자, 철자 확인

**원인 2: 시트 이름 불일치**
- 시트 이름이 `Sheet1`인지 확인
- 또는 `Code.gs`의 `SHEET_NAME` 변수 수정

**원인 3: Apps Script 코드 오류**
- Apps Script 편집기에서 **실행 로그** 확인
- 오류 메시지 확인

---

### ❌ "fetch is not defined" 오류 (Node.js 버전 문제)

**원인**: Node.js 버전이 18 미만

**해결 방법:**
1. Node.js 버전 확인: `node --version`
2. 18 미만이면 최신 버전으로 업데이트
3. 또는 `node-fetch` 패키지 설치:
   ```bash
   npm install node-fetch@2
   ```
4. `server.js` 상단에 추가:
   ```javascript
   const fetch = require('node-fetch');
   ```

---

### ❌ 스프레드시트에서 직접 수정한 내용이 웹에 반영되지 않음

**원인**: 브라우저 캐시

**해결 방법:**
1. 웹에서 **새로고침** 버튼 클릭
2. 또는 브라우저에서 `Ctrl+Shift+R` (강력 새로고침)
3. 10초마다 자동 새로고침되므로 잠시 대기

---

### ❌ 여러 사람이 동시에 수정하면 데이터가 꼬임

**원인**: 동시 접속 제어

**해결 방법:**
- `Code.gs`에 이미 Lock Service가 구현되어 있음
- 10초 동안 한 번에 한 명만 수정 가능
- 저장 버튼을 여러 번 누르지 않기

---

## 📊 데이터 구조

스프레드시트의 각 열은 다음과 같은 의미를 가집니다:

| 열 | 필드명 | 설명 | 예시 |
|---|--------|------|------|
| A | id | 고유 식별자 | 1737123456789 |
| B | counselor | 상담사 이름 | 김상담 |
| C | date | 날짜 | 2026-01-20 |
| D | startTime | 시작 시간 | 09:00 |
| E | endTime | 종료 시간 | 10:00 |
| F | clientName | 내담자 이름 | 홍길동 |
| G | sessionNumber | 회기 차수 | 1 |

---

## 🔒 보안 및 권한

### 누가 접근할 수 있나요?

**구글 스프레드시트:**
- 스프레드시트 소유자가 공유 설정으로 제어
- 기본적으로 소유자만 접근 가능

**웹 앱 (Apps Script):**
- "전체 사용자"로 설정 시 URL을 아는 누구나 접근 가능
- 팀원들과 URL을 공유하여 사용

**로컬 서버:**
- 같은 네트워크의 사용자만 접근 가능
- 외부에서는 접근 불가

### 보안 강화 방법

1. **웹 앱 URL 보호**
   - URL을 팀원들에게만 공유
   - 외부에 노출하지 않기

2. **스프레드시트 백업**
   - 정기적으로 스프레드시트 복사본 생성
   - **파일 > 사본 만들기**

3. **버전 관리**
   - Apps Script에서 **배포 관리**로 이전 버전 확인 가능
   - 문제 발생 시 이전 버전으로 롤백

---

## 🎯 장점

### ✅ 구글 스프레드시트 사용의 장점

1. **실시간 동기화**
   - 여러 명이 동시에 사용 가능
   - 변경사항이 즉시 반영

2. **데이터 안정성**
   - 구글 서버에 안전하게 저장
   - 자동 백업 및 버전 관리

3. **접근성**
   - 인터넷만 있으면 어디서든 접근
   - 별도의 데이터베이스 서버 불필요

4. **직접 편집 가능**
   - 스프레드시트에서 직접 데이터 수정 가능
   - 대량 데이터 입력/수정 용이

5. **무료**
   - 구글 계정만 있으면 무료 사용
   - 추가 비용 없음

---

## 📝 추가 팁

### 스프레드시트 공유하기

팀원들과 스프레드시트를 공유하려면:

1. 스프레드시트 우측 상단 **공유** 버튼 클릭
2. 팀원의 이메일 주소 입력
3. 권한 선택:
   - **뷰어**: 보기만 가능
   - **댓글 작성자**: 보기 + 댓글
   - **편집자**: 보기 + 수정 (권장)
4. **전송** 클릭

### 데이터 필터링 및 정렬

스프레드시트에서 직접:
- **데이터 > 필터 만들기**로 필터 적용
- 열 헤더 클릭하여 정렬
- 조건부 서식으로 시각화

### Apps Script 업데이트

코드를 수정한 경우:
1. Apps Script 편집기에서 코드 수정
2. **저장** (Ctrl+S)
3. **배포 > 배포 관리**
4. 현재 배포의 연필 아이콘 클릭
5. **버전** 드롭다운에서 **새 버전** 선택
6. **버전 배포** 클릭
7. URL은 동일하게 유지됨 (변경 불필요)

---

## 🎉 완료!

이제 구글 스프레드시트와 연동된 상담 스케줄 관리 시스템을 사용할 수 있습니다!

**다음 단계:**
1. 팀원들에게 `http://localhost:3000` URL 공유
2. 또는 같은 네트워크에서 `http://[내컴퓨터IP]:3000` 공유
3. 스프레드시트 편집 권한 공유

**문제가 있나요?**
- 서버 터미널 로그 확인
- 브라우저 개발자 도구(F12) Console 확인
- Apps Script 실행 로그 확인

---

© 2026 상담 스케줄 관리 시스템
